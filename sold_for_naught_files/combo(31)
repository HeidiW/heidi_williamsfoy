YUI.add("photostream-route",function(e){function s(e){s.superclass.constructor.call(this,e)}var t=25,n=50,r=100,i="pu";e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(s){var o=this,u,a,f=s.params.nsid_or_path_alias,l=s.headers?s.headers["user-agent"]:!1,c=s.params&&s.params.photo_id,h=c?r:t,p=this.getPageNumber(s),d,v={},m=[];l&&l.match(/^Twitterbot/i)!==null?this.isTwitterbot=!0:this.isTwitterbot=!1,a="/photos/"+f+"/",u={page:r/h*(p-1)+1,perPage:h,withPhotoId:c},u.orderBy="use_pref",u.viewAs="use_pref",e.TypeValidator.matches.nsid(f)?v.id=f:v.pathAlias=f;if(this.appContext.getViewer().signedIn||s.probableUser)m.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().signedIn?this.appContext.getViewer().nsid:s.probableUser)),m.push(this.appContext.getModel("person-contacts-count-models",v));return e.Promise.all(m).then(function(t){var l,h,m=t[0]?t[0]:!1,g,y=0,b={};return e.TypeValidator.matches.nsid(f)&&m&&(i=m.getValue("photostreamViewAsPref"),g=o.buildContextSuffix(m,f),v.id=f+"-"+g),o.appContext.getModel("photostream-models",v,u).then(function(t){h=t.getValue("owner").getValue("nsid");if(YUI.Env.isServer){y=Math.ceil(t.getValue("totalItems")/r);if(p>y&&u.page>1&&!isNaN(parseInt(s.params.page_number,10)))return e.Promise.resolve({redirect:a.replace(/page[0-9]+/,"")})}e.TypeValidator.matches.nsid(f)||(m?(i=m.getValue("photostreamViewAsPref"),g=o.buildContextSuffix(m,h),v.id=h+"-"+g):v.id=h),b.withPhotoId=c,b.contextSuffix=g,b.baseURL=a;if(c){l=t.getValue("photoPageList"),d=l.getPageOf({id:c},n);if(d===-1||l.getNextIncompletePage(u)===d)return u.forceAPICall=!0,l.getPage(u).then(function(e){return p=Math.ceil(l.getPageOf({id:c},n)*n/r),d=p,o.onRouteResolved(t,p,d,b)},function(e){return o.onRouteRejected(e,s,a)});p=Math.ceil(l.getPageOf({id:c},n)*n/r),d=p}else d=r/n*(p-1)+1;return o.onRouteResolved(t,p,d,b)},function(e){return o.onRouteRejected(e,s,a)})},function(e){return o.onRouteRejected(e,s,a)})},buildContextSuffix:function(t,n){var r=e.Models["person-preferences-models"].getReadablePrefName(t.getValue("photostreamViewOrderPref")),i=e.Models["person-preferences-models"].getReadablePrefName(t.getValue("photostreamViewAsPref"));return i===e.Models["person-preferences-models"].PHOTOSTREAM_VIEW_PREF_MAP.me||t.id!==n?r:r+"-"+i},onRouteResolved:function(t,s,o,u){var a,f=t.getValue("totalItems"),l=t.getValue("owner").getValue("displayname"),c=t.getValue("owner").getValue("nsid");return parseInt(f,10)===0&&this.appContext.flipper.isFlipped("enable-new-empty-state-pages")?a={view:"empty-page-view",fluid:!0,layout:"scrolling",title:l,params:{displayName:l,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:i,page:"photostream"}}:a={view:"photostream-page-view",fluid:!0,layout:"scrolling",title:l,params:{nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:u.withPhotoId,isTwitterbot:this.isTwitterbot,contextId:c+"-"+u.contextSuffix,pageParams:{page:o,perPage:u.withPhotoId?r:n,viewPageSize:r,nominalPage:s,idAttribute:"contextId"},baseURL:u.baseURL,contextSuffix:u.contextSuffix}},e.Promise.resolve(a)},onRouteRejected:function(t,n,r){var i="Couldn't load photostream page";if(t.code===15)return e.Promise.resolve({redirect:r});t.message&&(i+=": "+t.message);if(t.fatal)throw t;return this.displayRouteErrors(n,new e.RouteError(404,i))}})},"@VERSION@",{requires:["flickr-route","flickr-promise","type-validator","photostream-models","person-preferences-models"]});
